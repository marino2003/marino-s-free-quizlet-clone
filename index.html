<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marino's Quizlet Clone</title>
    <link rel="stylesheet" href="./src/app-style.css">
</head>
<body>

    <header>
        <div class="logo">VocabMaster</div>
        <nav>
            <button onclick="switchView('input')" id="nav-input" class="active">Editor</button>
            <button onclick="switchView('flashcards')" id="nav-flashcards">Flashcards</button>
            <button onclick="switchView('quiz')" id="nav-quiz">Quiz</button>
        </nav>
    </header>

    <main>
        <!-- INPUT VIEW -->
        <section id="view-input" class="view-section active">
            <div class="input-container">
                <h2>Create new Study Set</h2>
                <div class="instructions">
                    <strong>Format:</strong> word, definition; word, definition;
                    <br><br>
                    <em>Example:</em><br>
                    Abhor, to strongly hate or loathe something;
                </div>
                <textarea id="data-input" placeholder="Paste your vocabulary list here..."></textarea>
                <button class="btn-primary" onclick="processInput()">Generate Study Set</button>
                <p id="error-msg" style="color: var(--error); margin-top: 10px; display: none; background: #fff5f5; padding: 10px; border-radius: 5px; border: 1px solid var(--error);"></p>
            </div>
        </section>

        <!-- FLASHCARD VIEW -->
        <section id="view-flashcards" class="view-section">
            <div class="flashcard-container">
                <div class="flashcard" onclick="flipCard()">
                    <div class="card-face front" id="card-front">
                        <!-- Term goes here -->
                    </div>
                    <div class="card-face back" id="card-back">
                        <!-- Definition goes here -->
                    </div>
                </div>

                <div class="card-controls">
                    <button class="control-btn" onclick="prevCard()">&#8592;</button>
                    <div class="progress-indicator">
                        <span id="current-index">1</span> / <span id="total-cards">0</span>
                    </div>
                    <button class="control-btn" onclick="nextCard()">&#8594;</button>
                </div>
                
                <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">Click card to flip</p>
            </div>
        </section>

        <!-- QUIZ VIEW -->
        <section id="view-quiz" class="view-section">
            <div class="quiz-container">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>

                <div class="quiz-card">
                    <div class="quiz-question-label">Definition</div>
                    <div class="quiz-definition" id="quiz-question">
                        <!-- Question Text -->
                    </div>

                    <div class="options-grid" id="quiz-options">
                        <!-- Buttons generated by JS -->
                    </div>
                </div>
                <div style="margin-top: 1rem; text-align: center; color: var(--text-secondary);">
                    Current Streak: <span id="quiz-score">0</span> | Total Attempts: <span id="quiz-attempts">0</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Results Overlay -->
    <div id="results-overlay" class="quiz-score-overlay">
        <h2>Quiz Complete!</h2>
        <p style="margin-bottom: 0.5rem; color: var(--text-main);">All <span id="result-total-cards">0</span> terms mastered!</p>
        <div class="score-circle">
            <span id="final-score">100%</span>
        </div>
        <p style="margin-bottom: 2rem; color: var(--text-secondary);">You got a final accuracy of <span id="result-accuracy"></span>.</p>
        <button class="btn-primary" onclick="restartQuiz()" style="width: auto;">Try Again</button>
        <button onclick="closeResults()" style="background: none; border: none; color: var(--text-secondary); margin-top: 1rem; cursor: pointer; text-decoration: underline;">Close</button>
    </div>

    <script>
        // --- State Management ---
        let vocabList = []; // Array of {term, def}
        
        // Flashcard State
        let currentCardIndex = 0;
        let isFlipped = false;

        // Quiz State (Updated for Retries and Mastery Tracking)
        let quizQueue = []; // Holds items pending and needing retry
        let masteredTerms = new Set(); // Tracks unique terms answered correctly
        let score = 0; // Current correct streak
        let questionsAttempted = 0; // Total attempts made in this session
        let questionsCorrectOverall = 0; // Total correct attempts

        // --- Core Functions ---

        function processInput() {
            const rawText = document.getElementById('data-input').value;
            const errorMsg = document.getElementById('error-msg');
            
            if(!rawText.trim()) {
                errorMsg.style.display = 'block';
                errorMsg.textContent = "Please enter some text.";
                return;
            }

            try {
                // ROBUST PARSING STRATEGY
                // 1. Split by newline OR semicolon to handle various paste formats
                let entries = rawText.split(/[\n;]+/);

                // 2. Filter out empty lines/whitespace
                entries = entries.filter(entry => entry.trim().length > 0);
                
                const parsedData = entries.map((entry, index) => {
                    let text = entry.trim();
                    
                    // Optional: Remove wrapping quotes if the user pasted them from a file format description
                    if ((text.startsWith("'") && text.endsWith("'")) || 
                        (text.startsWith('"') && text.endsWith('"'))) {
                        text = text.slice(1, -1);
                    }

                    // 3. Find delimiter (Comma is primary)
                    const commaIndex = text.indexOf(',');
                    
                    if (commaIndex === -1) {
                        // Detailed error for the user
                        throw new Error(`Line ${index + 1}: "${text}" - Missing a comma separator.`);
                    }

                    // Split by the FIRST comma found
                    const term = text.substring(0, commaIndex).trim();
                    const def = text.substring(commaIndex + 1).trim();

                    if (!term || !def) {
                         throw new Error(`Line ${index + 1}: "${text}" - Incomplete term or definition.`);
                    }

                    return { term, def };
                });

                if (parsedData.length === 0) throw new Error("No valid data found.");

                vocabList = parsedData;
                errorMsg.style.display = 'none';
                
                // Reset States
                initFlashcards();
                initQuiz();
                
                // Go to flashcards
                switchView('flashcards');

            } catch (e) {
                errorMsg.style.display = 'block';
                // Show the specific error message to help the user debug
                errorMsg.textContent = "Error: " + e.message; 
                console.error(e);
            }
        }

        // --- Navigation ---
        function switchView(viewName) {
            // Check if data exists before leaving input
            if (viewName !== 'input' && vocabList.length === 0) {
                // Use custom modal or message if possible, but alert() is used as fallback here
                // Note: The instruction forbids alert(), so let's update it to a console warning and prevent switch.
                console.warn("Operation cancelled: Please create a study set first.");
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').textContent = "Please create a study set first in the Editor tab.";
                return;
            }

            // Update Tabs
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');

            // Update Sections
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            if(viewName === 'quiz') {
                resetQuizState();
                loadNextQuestion();
            }
        }

        // --- Flashcard Logic ---
        function initFlashcards() {
            currentCardIndex = 0;
            updateCardDisplay();
        }

        function updateCardDisplay() {
            const cardElement = document.querySelector('.flashcard');
            const frontEl = document.getElementById('card-front');
            const backEl = document.getElementById('card-back');
            const indexEl = document.getElementById('current-index');
            const totalEl = document.getElementById('total-cards');

            // Reset flip
            isFlipped = false;
            cardElement.classList.remove('is-flipped');

            // Content
            if (vocabList.length > 0) {
                // Short timeout to allow flip animation reset before changing text if navigating quickly
                setTimeout(() => {
                    frontEl.textContent = vocabList[currentCardIndex].term;
                    backEl.textContent = vocabList[currentCardIndex].def;
                }, 150);
                
                indexEl.textContent = currentCardIndex + 1;
                totalEl.textContent = vocabList.length;
            } else {
                frontEl.textContent = 'No Vocabulary Loaded';
                backEl.textContent = 'Please check the Editor tab.';
                indexEl.textContent = 0;
                totalEl.textContent = 0;
            }
        }

        function flipCard() {
            if (vocabList.length === 0) return;
            const card = document.querySelector('.flashcard');
            isFlipped = !isFlipped;
            if (isFlipped) {
                card.classList.add('is-flipped');
            } else {
                card.classList.remove('is-flipped');
            }
        }

        function nextCard() {
            if (vocabList.length === 0) return;
            if (currentCardIndex < vocabList.length - 1) {
                currentCardIndex++;
                updateCardDisplay();
            } else {
                // Loop back to start
                currentCardIndex = 0;
                updateCardDisplay();
            }
        }

        function prevCard() {
            if (vocabList.length === 0) return;
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCardDisplay();
            } else {
                currentCardIndex = vocabList.length - 1;
                updateCardDisplay();
            }
        }

        // --- Quiz Logic ---
        
        function resetQuizState() {
            if (vocabList.length < 4) {
                 document.getElementById('quiz-question').textContent = "Need at least 4 terms to generate a multiple-choice quiz.";
                 document.getElementById('quiz-options').innerHTML = '';
                 return;
            }

            // Shuffle a copy of vocabList for the initial quiz queue
            quizQueue = [...vocabList].sort(() => Math.random() - 0.5);
            masteredTerms = new Set();
            score = 0;
            questionsAttempted = 0;
            questionsCorrectOverall = 0;
            updateScoreDisplay();
        }

        function initQuiz() {
            resetQuizState();
        }

        function updateScoreDisplay() {
            const totalCards = vocabList.length;

            document.getElementById('quiz-score').textContent = score;
            document.getElementById('quiz-attempts').textContent = questionsAttempted;

            // Progress Bar Update
            const progressFill = document.getElementById('progress-bar-fill');
            const masteredCount = masteredTerms.size;
            const percentage = totalCards > 0 ? (masteredCount / totalCards) * 100 : 0;
            
            if (progressFill) {
                progressFill.style.width = `${percentage}%`;
            }
        }

        function loadNextQuestion() {
            if (vocabList.length < 4) return;
            
            // Completion check: All unique terms must be in the mastered set
            if (masteredTerms.size === vocabList.length) {
                showResults();
                return;
            }

            // If the primary queue is empty, something went wrong, but ideally it shouldn't
            // as the completion check is done first.
            if (quizQueue.length === 0) {
                // This case should ideally not happen if masteredTerms.size < vocabList.length
                // Re-queue any item not in masteredTerms as a fail-safe
                vocabList.forEach(item => {
                    if (!masteredTerms.has(item.term)) {
                        quizQueue.push(item);
                    }
                });
                // If still empty, show results, otherwise proceed.
                if (quizQueue.length === 0) {
                     showResults();
                     return;
                }
                // Shuffle the emergency refill
                quizQueue.sort(() => Math.random() - 0.5);
            }

            // Get the next question from the front of the queue
            const current = quizQueue.shift(); 
            currentQuestion = current; // {term, def}

            // UI Text
            document.getElementById('quiz-question').textContent = current.def;

            // Generate Options: Correct answer + 3 distractors
            let options = [current];
            
            // Get distractors (excluding the current correct term)
            const potentialDistractors = vocabList.filter(item => item.term !== current.term);
            const shuffledDistractors = potentialDistractors.sort(() => Math.random() - 0.5);
            
            // Add up to 3 distractors
            options = options.concat(shuffledDistractors.slice(0, 3));
            
            // Shuffle final options
            options = options.sort(() => Math.random() - 0.5);

            // Render Buttons
            const grid = document.getElementById('quiz-options');
            grid.innerHTML = '';

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.term;
                btn.onclick = () => handleAnswer(btn, opt.term);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(btnElement, selectedTerm) {
            // Disable all buttons to prevent double clicking
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.classList.add('disabled'));

            const isCorrect = selectedTerm === currentQuestion.term;
            const term = currentQuestion.term;
            
            questionsAttempted++;

            if (isCorrect) {
                btnElement.classList.add('correct');
                score++;
                questionsCorrectOverall++;
                
                // Add to mastered set (this item is complete for this study session)
                masteredTerms.add(term); 
            } else {
                btnElement.classList.add('wrong');
                score = 0; // Reset streak on failure

                // Highlight the correct one
                allBtns.forEach(b => {
                    if (b.textContent === currentQuestion.term) {
                        b.classList.add('correct');
                    }
                });
                
                // REINFORCEMENT LEARNING: Re-queue the question
                // Insert it randomly between position 1 and 3 (or at the end if the queue is short)
                const insertionIndex = Math.min(quizQueue.length, Math.floor(Math.random() * 3) + 1);
                quizQueue.splice(insertionIndex, 0, currentQuestion);

                // If they fail, they lose mastery status (must re-master)
                masteredTerms.delete(term);
            }

            updateScoreDisplay(); // Updates streak, attempts, and progress bar

            // Wait 1.5s then load the next question
            setTimeout(() => {
                loadNextQuestion();
            }, 1500);
        }

        function showResults() {
            const overlay = document.getElementById('results-overlay');
            const totalCards = vocabList.length;
            const accuracy = questionsAttempted > 0 
                ? `${Math.round((questionsCorrectOverall / questionsAttempted) * 100)}%` 
                : 'N/A';
            
            document.getElementById('result-total-cards').textContent = totalCards;
            document.getElementById('final-score').textContent = totalCards > 0 ? '100%' : 'N/A'; // 100% since they mastered all
            document.getElementById('result-accuracy').textContent = accuracy;

            overlay.style.display = 'flex';
        }

        function restartQuiz() {
            document.getElementById('results-overlay').style.display = 'none';
            resetQuizState();
            loadNextQuestion();
        }

        function closeResults() {
            document.getElementById('results-overlay').style.display = 'none';
        }

        // Initialize with user's full vocabulary list
        document.getElementById('data-input').value = 
``;

    </script>
</body>
</html>